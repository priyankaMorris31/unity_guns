<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Photon Room List</title>
    <script src="./photon.js"></script>
    <style>
        .room-item {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Available Rooms</h1>
    <div id="status">Connecting...</div>
    <button onclick="refreshRoomList()">Refresh Rooms</button>
    <div id="roomList"></div>

    <script>
        let client;
        
        window.onload = function() {
            const LBC = Photon.LoadBalancing.LoadBalancingClient;
            
            // Initialize with your Unity app settings
            client = new LBC(
                Photon.ConnectionProtocol.Wss,
                "67d44a00-4f4b-437e-b8b5-a3305f2522c8",
                "1.0"
            );

            // Handle state changes
            client.onStateChange = function(state) {
                const statusDiv = document.getElementById("status");
                console.log("State:", LBC.StateToName(state));
                
                switch(state) {
                    case LBC.State.ConnectedToMaster:
                        statusDiv.textContent = "Connected to Master - Joining Lobby...";
                        // Join the default lobby
                        client.joinLobby();
                        break;
                        
                    case LBC.State.JoinedLobby:
                        statusDiv.textContent = "Connected - Fetching Rooms...";
                        // Get room list automatically when joining lobby
                        break;
                        
                    case LBC.State.Disconnected:
                        statusDiv.textContent = "Disconnected - Reconnecting...";
                        setTimeout(() => {
                            client.connectToRegionMaster("eu");
                        }, 1000);
                        break;
                }
            };

            // Handle errors
            client.onError = function(errorCode, errorMsg) {
                console.error("Error:", errorCode, errorMsg);
                document.getElementById("status").textContent = "Error: " + errorMsg;
            };

            // Handle room list updates
            client.onRoomListUpdate = function(rooms) {
                console.log("Room list updated:", rooms);
                updateRoomList(rooms);
            };

            // Start connection when Photon is loaded
            Photon.setOnLoad(() => {
                client.connectToRegionMaster("eu");
            });
        };

        function refreshRoomList() {
            if (client && client.isInLobby()) {
                // Room list updates automatically in lobby
                document.getElementById("status").textContent = "Refreshing room list...";
            } else {
                console.log("Not in lobby, reconnecting...");
                client.connectToRegionMaster("eu");
            }
        }

        function updateRoomList(rooms) {
            const listEl = document.getElementById("roomList");
            listEl.innerHTML = "";
            
            if (!rooms || rooms.length === 0) {
                listEl.innerHTML = "<div class='room-item'>No rooms available</div>";
                return;
            }

            rooms.forEach(room => {
                const div = document.createElement("div");
                div.className = "room-item";
                
                // Get real player count and NPC count from room properties
                let realPlayerCount = room.playerCount;
                let npcCount = 0;
                let totalPlayers = realPlayerCount;
                let gameState = "Waiting";
                
                if (room.customProperties) {
                    realPlayerCount = room.customProperties["RealPlayerCount"] || realPlayerCount;
                    npcCount = room.customProperties["NPCCount"] || 0;
                    totalPlayers = room.customProperties["TotalPlayers"] || realPlayerCount;
                    gameState = room.customProperties["GameState"] || "Waiting";
                }

                const details = [
                    `Room Name: ${room.name}`,
                    `Real Players: ${realPlayerCount}/6`,
                    `Bots: ${npcCount}`,
                    `Total: ${totalPlayers}/6`,
                    `Status: ${gameState}`,
                    `Open: ${room.isOpen ? "Yes" : "No"}`,
                    `Visible: ${room.isVisible ? "Yes" : "No"}`
                ];
                
                div.textContent = details.join(' | ');
                listEl.appendChild(div);
            });
        }
    </script>
</body>
</html>
